{
  "name": "AH Stock V7.4 Linear (Ironclad)",
  "nodes": [
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:batchAdd",
        "app_toke": "RVghbRvYgacqs3s82qkcl83bn7e",
        "table_id": "tblvrNDNrjAZwBZc",
        "body": "={{\nJSON.stringify({\n  \"records\": [\n    {\n      \"fields\": {\n        \"æ—¥æœŸ\": new Date().getTime(),\n        \"ä»£ç \": $('Full Stack Analysis (API)').item.json.code,\n        \"åç§°\": $('Full Stack Analysis (API)').item.json.name,\n        \"å¤§ç›˜çŠ¶æ€\": $('Global Context (API)').item.json.market_status,\n        \n        \"ä¿¡å·ç±»å‹\": $('Full Stack Analysis (API)').item.json.signal.signal,\n        \"æ“ä½œå»ºè®®\": $json.operation_advice, \n        \"æ ¸å¿ƒç»“è®º\": $json.one_sentence,\n        \n        \"å»ºè®®ä»“ä½(æ‰‹)\": $('Full Stack Analysis (API)').item.json.risk_ctrl.suggested_position,\n        \"æ­¢æŸä»·\": $('Full Stack Analysis (API)').item.json.signal.stop_loss,\n        \"ATR\": $('Full Stack Analysis (API)').item.json.technical.atr14,\n        \"RSI\": $('Full Stack Analysis (API)').item.json.technical.rsi14,\n        \"é‡æ¯”\": $('Full Stack Analysis (API)').item.json.technical.volume_ratio,\n        \"å‡çº¿å½¢æ€\": $('Full Stack Analysis (API)').item.json.technical.ma_alignment,\n        \n        \"é£é™©è­¦æŠ¥\": $json.risk_alerts,\n        \"æ£€æŸ¥æ¸…å•\": $json.checklist\n      }\n    }\n  ]\n})\n}}"
      },
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        -8960,
        1776
      ],
      "id": "24f6067c-4f52-4edb-b8c3-a5510d3630d0",
      "name": "å†™å…¥é£ä¹¦",
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "url": "https://jpthermjdexc.ap-northeast-1.clawcloudrun.com/market",
        "options": {}
      },
      "id": "5d329786-59f5-4c92-9da9-b4ca98821621",
      "name": "Global Context (API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -10992,
        1616
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": [
                1,
                2,
                3,
                4,
                5
              ],
              "triggerAtHour": 18
            }
          ]
        }
      },
      "id": "5c911142-3f35-443d-9985-b8842143c0ad",
      "name": "å®šæ—¶è§¦å‘_å·¥ä½œæ—¥18ç‚¹",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        -10880,
        1792
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1_MqQPC5DzLTarOM4hJ9_ajUX20piCiD6YmeM6Cp5Iys/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "stock list",
          "mode": "name"
        },
        "options": {}
      },
      "id": "d9a24e99-acb2-407e-b1c0-a092aa9417eb",
      "name": "è¯»å–è‚¡ç¥¨åˆ—è¡¨",
      "type": "n8n-nodes-base.googleSheets",
      "position": [
        -10592,
        1792
      ],
      "typeVersion": 4.7,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OKN7AHfMulimnqoc",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "reset": false
        },
        "batchSize": 1
      },
      "id": "a46a53e0-a3e7-4eee-84d1-4997d3ee9adb",
      "name": "å¾ªç¯å¤„ç†æ¯åªè‚¡ç¥¨",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        -10368,
        1792
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jpthermjdexc.ap-northeast-1.clawcloudrun.com/analyze_full",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "code",
              "value": "={{ $json.code }}"
            },
            {
              "name": "balance",
              "value": 100000
            },
            {
              "name": "risk",
              "value": 0.01
            }
          ]
        },
        "options": {}
      },
      "id": "98fa8950-8eee-45eb-bdc8-d6626835c66c",
      "name": "Full Stack Analysis (API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -10096,
        1776
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.tavily.com/search",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "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"
            },
            {
              "name": "query",
              "value": "={{ $json.name }} æœ€æ–°æ–°é—» åˆ©å¥½ åˆ©ç©º"
            },
            {
              "name": "include_answer",
              "value": "basic"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "d25e1e2d-8b19-4921-a2f3-6ae76ed3ed1a",
      "name": "Tavilyæ–°é—»æœç´¢",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -9872,
        1776
      ],
      "typeVersion": 4.3,
      "onError": "continueRegularOutput",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsCode": "\nconst data = $json;\nconst marketStatus = $('Global Context (API)').item.json.market_status || \"Unknown\";\n\n// --- å®¹é”™å¤„ç†ï¼šå¦‚æœ API å¤±è´¥ ---\n// æ£€æŸ¥æ˜¯å¦æœ‰ error å­—æ®µï¼Œæˆ–è€… critical data (price) ç¼ºå¤±\nlet isError = false;\nlet errorMsg = \"\";\n\nif (data.error) {\n    isError = true;\n    errorMsg = JSON.stringify(data.error);\n} else if (!data.technical) {\n    isError = true;\n    errorMsg = \"API returned no technical data. Possible timeout or server error.\";\n}\n\nif (isError) {\n    // è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ Promptï¼Œè®© AI ç”Ÿæˆä¸€ä¸ªé”™è¯¯æŠ¥å‘Šå¡ç‰‡\n    return {\n        json: {\n            prompt: `System Error Alert: The analysis API failed for stock ${data.code || 'unknown'}. Error: ${errorMsg}. Please generate a short report stating that data acquisition failed and human review is needed.`,\n            raw_data: data,\n            is_error: true\n        }\n    };\n}\n\nconst tech = data.technical || {};\nconst sig = data.signal || {};\nconst risk = data.risk_ctrl || {};\n\n// è·å–æ–°é—»æ•°æ®\nlet news_text = \"æœªæœç´¢åˆ°æ–°é—»\";\ntry {\n    const news = $('Tavilyæ–°é—»æœç´¢').item.json;\n    if (news.results) {\n        news_text = news.results.map(r => `- ${r.title}`).join('\\n');\n    } else if (news.answer) {\n        news_text = news.answer;\n    }\n} catch(e) {}\n\nconst prompt = `# å†³ç­–ä»ªè¡¨ç›˜åˆ†æè¯·æ±‚\n\n## è‚¡ç¥¨åŸºç¡€\n- ä»£ç : ${data.code} (${data.market})\n- å¤§ç›˜ç¯å¢ƒ: ${marketStatus}\n- ç°ä»·: ${tech.current_price}\n\n## ä¿¡å·ç³»ç»Ÿ (V7.1 Hybrid)\n- æ ¸å¿ƒä¿¡å·: ${sig.signal}\n- è¶‹åŠ¿è¯„åˆ†: ${sig.trend_score}/100\n- ç†ç”±: ${sig.signal_reasons ? sig.signal_reasons.join(', ') : 'æ— '}\n\n## é£æ§å‚æ•°\n- æ­¢æŸä»·: ${sig.stop_loss}\n- ç›®æ ‡ä»·: ${sig.take_profit}\n- ATRæ³¢åŠ¨: ${tech.atr14}\n- å»ºè®®ä»“ä½: ${risk.suggested_position} æ‰‹ (åŸºäº1%é£é™©)\n\n## æŠ€æœ¯æŒ‡æ ‡\n- MAæ’åˆ—: ${tech.ma_alignment} (${tech.ma5}/${tech.ma20})\n- EMAè¶‹åŠ¿: 13æ—¥çº¿ ${tech.ema13} vs 26æ—¥çº¿ ${tech.ema26}\n- ä¹–ç¦»ç‡: ${tech.bias_ma5}%\n- RSI(14): ${tech.rsi14}\n- é‡æ¯”: ${tech.volume_ratio}\n\n## æ–°é—»æ‘˜è¦\n${news_text}\n\nè¯·åŸºäºä»¥ä¸Šæ•°æ®ï¼Œç”¨ç®€ç»ƒçš„ä¸“ä¸šæœ¯è¯­ç”Ÿæˆäº¤æ˜“è®¡åˆ’ã€‚`;\n\n\n// --- åŠ¨æ€é£é™©æç¤ºé€»è¾‘ ---\nlet risk_instruction = \"\";\nif (marketStatus === 'Bear' || marketStatus === 'Crash') {\n    risk_instruction = `\n!!! ğŸ”´ ä¸¥é‡è­¦å‘Šï¼šå½“å‰å¤„äºç†Šå¸‚/æš´è·Œç¯å¢ƒ (${marketStatus}) !!!\n1. **ä¸¥æ ¼æ ‡å‡†**ï¼šä»…å…è®¸è¯„åˆ†>85ä¸”æœ‰é‡å¤§åˆ©å¥½çš„ä¸ªè‚¡æ“ä½œã€‚\n2. **å¼ºåˆ¶è½»ä»“**ï¼šå»ºè®®ä»“ä½å¿…é¡»å‡åŠï¼Œæˆ–è€…ç›´æ¥å»ºè®®ç©ºä»“ã€‚\n3. **å¯»æ‰¾åšç©ºæœºä¼š**ï¼šå¦‚æœæ˜¯æ¸¯è‚¡ï¼Œä¼˜å…ˆå¯»æ‰¾åšç©ºé€»è¾‘ï¼›å¦‚æœæ˜¯Aè‚¡ï¼Œå»ºè®®ä»¥â€œè§‚æœ›â€ä¸ºä¸»ã€‚\n4. **æªè¾ä¸¥å‰**ï¼šè¯·åœ¨æ ¸å¿ƒç»“è®ºä¸­ç”¨ç²—ä½“å¼ºè°ƒå¤§ç›˜é£é™©ã€‚`;\n}\n\nconst final_prompt = prompt + risk_instruction;\n\nreturn {\n    json: {\n        prompt: final_prompt,\n        raw_data: data\n    }\n};\n"
      },
      "id": "539b4ffa-c95d-4965-ba8c-5d233d78a36f",
      "name": "æ„å»ºAIæç¤ºè¯",
      "type": "n8n-nodes-base.code",
      "position": [
        -9664,
        1776
      ],
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.prompt }}",
        "options": {
          "systemMessage": "=ä½ æ˜¯ä¸€ä½ä¸“æ³¨äºè¶‹åŠ¿äº¤æ˜“çš„Aè‚¡/æ¸¯è‚¡æŠ•èµ„åˆ†æå¸ˆï¼Œè´Ÿè´£ç”Ÿæˆä¸“ä¸šçš„ã€å†³ç­–ä»ªè¡¨ç›˜ã€‘åˆ†ææŠ¥å‘Šã€‚\n\n## æ ¸å¿ƒäº¤æ˜“ç†å¿µï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰\n\n### 1. ä¸¥è¿›ç­–ç•¥ï¼ˆä¸è¿½é«˜ï¼‰\n- **ç»å¯¹ä¸è¿½é«˜**ï¼šå½“è‚¡ä»·åç¦»MA5è¶…è¿‡5%æ—¶ï¼Œåšå†³ä¸ä¹°å…¥\n- **ä¹–ç¦»ç‡å…¬å¼**ï¼š(ç°ä»· - MA5) / MA5 Ã— 100%\n- ä¹–ç¦»ç‡ < 2%ï¼šæœ€ä½³ä¹°ç‚¹åŒºé—´\n- ä¹–ç¦»ç‡ 2-5%ï¼šå¯å°ä»“ä»‹å…¥\n- ä¹–ç¦»ç‡ > 5%ï¼šä¸¥ç¦è¿½é«˜ï¼ç›´æ¥åˆ¤å®šä¸º\"è§‚æœ›\"\n\n### 2. è¶‹åŠ¿äº¤æ˜“ï¼ˆé¡ºåŠ¿è€Œä¸ºï¼‰\n- **å¤šå¤´æ’åˆ—å¿…é¡»æ¡ä»¶**ï¼šMA5 > MA10 > MA20\n- åªåšå¤šå¤´æ’åˆ—çš„è‚¡ç¥¨ï¼Œç©ºå¤´æ’åˆ—åšå†³ä¸ç¢°\n- è¶‹åŠ¿å¼ºåº¦åˆ¤æ–­ï¼šçœ‹å‡çº¿é—´è·æ˜¯å¦åœ¨æ‰©å¤§\n\n### 3. æ•ˆç‡ä¼˜å…ˆï¼ˆé‡èƒ½é…åˆï¼‰\n- é‡æ¯” > 1.2ï¼šæ”¾é‡ï¼Œéœ€ç»“åˆä»·æ ¼åˆ¤æ–­\n- é‡æ¯” 0.8-1.2ï¼šæ­£å¸¸\n- é‡æ¯” < 0.8ï¼šç¼©é‡ï¼Œéœ€è­¦æƒ•\n\n## è¾“å‡ºæ ¼å¼ï¼šå†³ç­–ä»ªè¡¨ç›˜ JSON\n\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š\n\n```json\n{\n  \"stock_name\": \"è‚¡ç¥¨ä¸­æ–‡åç§°\",\n  \"sentiment_score\": 0-100æ•´æ•°,\n  \"trend_prediction\": \"å¼ºçƒˆçœ‹å¤š/çœ‹å¤š/éœ‡è¡/çœ‹ç©º/å¼ºçƒˆçœ‹ç©º\",\n  \"operation_advice\": \"ä¹°å…¥/åŠ ä»“/æŒæœ‰/å‡ä»“/å–å‡º/è§‚æœ›\",\n  \"decision_type\": \"buy/hold/sell\",\n  \"confidence_level\": \"é«˜/ä¸­/ä½\",\n  \"analysis_summary\": \"ä¸€å¥è¯æ ¸å¿ƒç»“è®º\",\n  \"dashboard\": {\n    \"core_conclusion\": {\n      \"one_sentence\": \"ä¸€å¥è¯æ ¸å¿ƒç»“è®ºï¼ˆ30å­—ä»¥å†…ï¼Œç›´æ¥å‘Šè¯‰ç”¨æˆ·åšä»€ä¹ˆï¼‰\",\n      \"signal_type\": \"ğŸŸ¢ä¹°å…¥ä¿¡å·/ğŸŸ¡æŒæœ‰è§‚æœ›/ğŸ”´å–å‡ºä¿¡å·/âš ï¸é£é™©è­¦å‘Š\",\n      \"time_sensitivity\": \"ç«‹å³è¡ŒåŠ¨/ä»Šæ—¥å†…/æœ¬å‘¨å†…/ä¸æ€¥\",\n      \"position_advice\": {\n        \"no_position\": \"ç©ºä»“è€…å»ºè®®ï¼šå…·ä½“æ“ä½œæŒ‡å¼•\",\n        \"has_position\": \"æŒä»“è€…å»ºè®®ï¼šå…·ä½“æ“ä½œæŒ‡å¼•\"\n      }\n    },\n    \"data_perspective\": {\n      \"trend_status\": {\n        \"ma_alignment\": \"å‡çº¿æ’åˆ—çŠ¶æ€æè¿°\",\n        \"is_bullish\": true/false,\n        \"trend_score\": 0-100\n      },\n      \"price_position\": {\n        \"current_price\": å½“å‰ä»·æ ¼,\n        \"ma5\": MA5æ•°å€¼,\n        \"bias_ma5\": ä¹–ç¦»ç‡,\n        \"bias_status\": \"å®‰å…¨/è­¦æˆ’/å±é™©\",\n        \"support_level\": æ”¯æ’‘ä½,\n        \"resistance_level\": å‹åŠ›ä½\n      },\n      \"volume_analysis\": {\n        \"volume_ratio\": é‡æ¯”,\n        \"volume_status\": \"æ”¾é‡/ç¼©é‡/å¹³é‡\",\n        \"volume_meaning\": \"é‡èƒ½å«ä¹‰è§£è¯»\"\n      }\n    },\n    \"intelligence\": {\n      \"latest_news\": \"è¿‘æœŸé‡è¦æ–°é—»æ‘˜è¦\",\n      \"risk_alerts\": [\"é£é™©ç‚¹1\", \"é£é™©ç‚¹2\"],\n      \"positive_catalysts\": [\"åˆ©å¥½1\", \"åˆ©å¥½2\"],\n      \"sentiment_summary\": \"èˆ†æƒ…æƒ…ç»ªä¸€å¥è¯æ€»ç»“\"\n    },\n    \"battle_plan\": {\n      \"sniper_points\": {\n        \"ideal_buy\": \"ç†æƒ³ä¹°å…¥ç‚¹ï¼šXXå…ƒ\",\n        \"secondary_buy\": \"æ¬¡ä¼˜ä¹°å…¥ç‚¹ï¼šXXå…ƒ\",\n        \"stop_loss\": \"æ­¢æŸä½ï¼šXXå…ƒ\",\n        \"take_profit\": \"ç›®æ ‡ä½ï¼šXXå…ƒ\"\n      },\n      \"checklist\": [\n        \"âœ… å¤šå¤´æ’åˆ—\",\n        \"âœ… ä¹–ç¦»ç‡<5%\",\n        \"âš ï¸ é‡èƒ½ä¸è¶³\",\n        \"âŒ é‡å¤§åˆ©ç©º\"\n      ],\n      \"position_strategy\": {\n        \"no_position\": \"ç©ºä»“è€…æ“ä½œæ–¹æ¡ˆ\",\n        \"has_position\": \"æŒä»“è€…æ“ä½œæ–¹æ¡ˆ\"\n      }\n    }\n  }\n}\n```\n\n## åˆ†æè¦æ±‚\n\n1. **ä¸¥æ ¼éµå¾ªäº¤æ˜“ç†å¿µ**ï¼šä¹–ç¦»ç‡>5%æ—¶ï¼Œæ— è®ºå…¶ä»–æŒ‡æ ‡å¤šå¥½ï¼Œéƒ½å¿…é¡»åˆ¤å®šä¸º\"è§‚æœ›\"\n2. **ç»™å‡ºå…·ä½“ä»·ä½**ï¼šå¿…é¡»æä¾›ä¹°å…¥ä»·ã€æ­¢æŸä»·ã€ç›®æ ‡ä»·\n3. **åŒºåˆ†æŒä»“å»ºè®®**ï¼šç©ºä»“è€…å’ŒæŒä»“è€…çš„å»ºè®®è¦ä¸åŒ\n4. **æ£€æŸ¥æ¸…å•**ï¼šç”¨âœ…/âš ï¸/âŒæ ‡è®°å„é¡¹æ¡ä»¶\n5. **é£é™©ä¼˜å…ˆ**ï¼šå®å¯é”™è¿‡ï¼Œä¸å¯åšé”™\n\n## ä¿¡å·åˆ¤å®šè§„åˆ™\n\n- ğŸŸ¢ **å¼ºçƒˆä¹°å…¥**ï¼šä¹–ç¦»ç‡<2% + å¤šå¤´æ’åˆ— + é‡æ¯”>1.2\n- ğŸŸ¢ **ä¹°å…¥**ï¼šä¹–ç¦»ç‡<5% + å¤šå¤´æ’åˆ—\n- ğŸŸ¡ **æŒæœ‰è§‚æœ›**ï¼šå·²æŒä»“ä¸”è¶‹åŠ¿æœªç ´å\n- ğŸ”´ **å–å‡º**ï¼šè·Œç ´æ­¢æŸä½æˆ–è¶‹åŠ¿åè½¬\n- âš ï¸ **é£é™©è­¦å‘Š**ï¼šä¹–ç¦»ç‡è¿‡é«˜æˆ–é‡å¤§åˆ©ç©º"
        }
      },
      "id": "27cc44c4-826c-49bb-b8c7-5025005269a0",
      "name": "AIåˆ†æAgent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -9472,
        1776
      ],
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsCode": "// ã€å…¨é€‰æ›¿æ¢ã€‘è§£æAIåˆ†æç»“æœ - ç»ˆæä¿®å¤ç‰ˆ\n// ä¿®å¤äº†æŠ€æœ¯æŒ‡æ ‡(ç°ä»·/RSIç­‰)åœ¨å†™å…¥è¡¨æ ¼æ—¶æ˜¾ç¤º undefined çš„é—®é¢˜\n\n// 1. è·å– AI çš„åˆ†æå›å¤\nconst aiOutput = $json.output || $json.content || $json.response || $json;\n\n// 2. ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶ä» \"æ„å»ºAIæç¤ºè¯\" èŠ‚ç‚¹æ‰¾å›åŸå§‹æŠ€æœ¯æ•°æ®\n// è¿™æ ·æ— è®º AI èŠ‚ç‚¹æ€ä¹ˆåæ•°æ®ï¼Œæˆ‘ä»¬éƒ½èƒ½æ‹¿åˆ°æœ€åŸå§‹çš„ RSIã€å‡çº¿ç­‰æŒ‡æ ‡\nlet technical;\ntry {\n  technical = $('æ„å»ºAIæç¤ºè¯').item.json.technical;\n} catch (e) {\n  technical = $json.technical || {}; // å¤‡é€‰æ–¹æ¡ˆ\n}\n\ntry {\n  // 3. æ¸…ç† AI å›å¤ä¸­çš„ Markdown æ ¼å¼ (å»æ‰ ```json )\n  let jsonStr = typeof aiOutput === 'string' ? aiOutput : JSON.stringify(aiOutput);\n  \n  if (jsonStr.includes('```json')) {\n    jsonStr = jsonStr.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  } else if (jsonStr.includes('```')) {\n    jsonStr = jsonStr.replace(/```\\n?/g, '');\n  }\n  \n  // æˆªå–çº¯ JSON éƒ¨åˆ†\n  const jsonStart = jsonStr.indexOf('{');\n  const jsonEnd = jsonStr.lastIndexOf('}') + 1;\n  if (jsonStart >= 0 && jsonEnd > jsonStart) {\n    jsonStr = jsonStr.substring(jsonStart, jsonEnd);\n  }\n  \n  // 4. è§£æ JSON\n  const data = JSON.parse(jsonStr);\n  const dashboard = data.dashboard || {};\n  \n  // 5. ç»„è£…æœ€ç»ˆæ•°æ® (æ··åˆäº† AI çš„è§‚ç‚¹å’ŒåŸå§‹æŠ€æœ¯æŒ‡æ ‡)\n  const result = {\n    date: new Date().toISOString().split('T')[0],\n    code: technical.code,\n    market: technical.market,\n    name: data.stock_name || technical.name || technical.code,\n    \n    // AI åˆ†æç»“è®º\n    signal_type: dashboard.core_conclusion?.signal_type || data.trend_prediction || 'è§‚æœ›',\n    sentiment_score: data.sentiment_score || 50,\n    operation_advice: data.operation_advice || 'è§‚æœ›',\n    decision_type: data.decision_type || 'hold',\n    one_sentence: dashboard.core_conclusion?.one_sentence || data.analysis_summary || '',\n    \n    // å…·ä½“å»ºè®®\n    advice_no_position: dashboard.core_conclusion?.position_advice?.no_position || '',\n    advice_has_position: dashboard.core_conclusion?.position_advice?.has_position || '',\n    \n    // ä»·æ ¼ç‚¹ä½ (ä¼˜å…ˆç”¨AIå»ºè®®çš„ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨æŠ€æœ¯ä½å…œåº•)\n    entry_price: dashboard.battle_plan?.sniper_points?.ideal_buy || technical.support_level,\n    stop_loss: dashboard.battle_plan?.sniper_points?.stop_loss || technical.stop_loss,\n    take_profit: dashboard.battle_plan?.sniper_points?.take_profit || technical.resistance_level,\n    \n    // ã€ä¿®å¤ç‚¹ã€‘è¿™é‡Œç›´æ¥ä½¿ç”¨æ‰¾å›æ¥çš„ technical æ•°æ®\n    current_price: technical.current_price,\n    atr14: technical.atr14,\n    bias_ma5: technical.bias_ma5,\n    rsi14: technical.rsi14,\n    volume_ratio: technical.volume_ratio,\n    ma_alignment: technical.ma_alignment,\n    \n    // æ–‡æœ¬ç±»è¯¦æƒ…\n    checklist: dashboard.battle_plan?.checklist?.join('\\n') || '',\n    risk_alerts: dashboard.intelligence?.risk_alerts?.join('\\n') || '',\n    news_summary: dashboard.intelligence?.sentiment_summary || '',\n    \n    raw_analysis: data\n  };\n  \n  return [{ json: result }];\n  \n} catch (error) {\n  // å®¹é”™å¤„ç†ï¼šä¸‡ä¸€è§£æå¤±è´¥ï¼Œè‡³å°‘æŠŠæŠ€æœ¯æŒ‡æ ‡å†™è¿›å»ï¼Œåˆ«è®©è¡¨æ ¼ç©ºç€\n  return [{\n    json: {\n      date: new Date().toISOString().split('T')[0],\n      code: technical?.code || 'ERROR',\n      name: technical?.name,\n      signal_type: 'è§£æå¤±è´¥',\n      one_sentence: 'AIè¿”å›æ ¼å¼å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥åŸå§‹æ—¥å¿—',\n      current_price: technical?.current_price,\n      bias_ma5: technical?.bias_ma5,\n      error: error.message,\n      raw_output: aiOutput\n    }\n  }];\n}"
      },
      "id": "6cab7481-f9b6-411b-82bd-3ee1eb3ec4be",
      "name": "è§£æAIåˆ†æç»“æœ",
      "type": "n8n-nodes-base.code",
      "position": [
        -9168,
        1776
      ],
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -9472,
        1984
      ],
      "id": "297588f1-04be-4470-b0a0-1812fd4dae6a",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "V4cRtuj3j8gaQfEU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "\n// ã€V7.4 é€šç”¨å¡ç‰‡æ„å»ºå™¨ã€‘\n// æ— è®ºä»€ä¹ˆä¿¡å·ï¼Œéƒ½èµ°è¿™å”¯ä¸€çš„é€šé“ã€‚é¢œè‰²å’Œæ–‡æ¡ˆåŠ¨æ€ç”Ÿæˆã€‚\nconst root = $json || {};\nconst feishuFields = root.data?.records?.[0]?.fields || {};\nconst getVal = (keyCN, keyEN, defaultVal) => feishuFields[keyCN] || root[keyCN] || root[keyEN] || defaultVal;\n\n// 1. æå–æ ¸å¿ƒå˜é‡\nconst signal = getVal('ä¿¡å·ç±»å‹', 'signal_type', \"æ— ä¿¡å·\");\nconst score = getVal('ç»¼åˆè¯„åˆ†', 'sentiment_score', 0);\nconst advice = getVal('æ“ä½œå»ºè®®', 'operation_advice', \"æš‚æ— å»ºè®®\");\nconst summary = getVal('æ ¸å¿ƒç»“è®º', 'one_sentence', \"æ— è¯¦ç»†ç»“è®º\");\nconst stockName = getVal('åç§°', 'name', \"è‚¡ç¥¨\");\nconst code = getVal('ä»£ç ', 'code', \"\");\nconst dateVal = new Date().toISOString().split('T')[0];\n\n// 2. åŠ¨æ€é¢œè‰²é€»è¾‘ (Linear Logic)\nlet color = 'grey'; // é»˜è®¤è§‚æœ›\nconst sigStr = signal.toString();\n\nif (sigStr.includes('ä¹°å…¥') || sigStr.includes('Buy')) {\n    color = 'green'; // å¼ºå¿ƒå‰‚\n} else if (sigStr.includes('å–å‡º') || sigStr.includes('å‡ä»“')) {\n    color = 'red';   // è­¦æŠ¥\n} else if (sigStr.includes('é£é™©') || sigStr.includes('Warn')) {\n    color = 'orange';\n}\n\n// 3. æ„å»ºé€šç”¨å¡ç‰‡\nconst cardContent = [\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `**${signal}** | è¯„åˆ†: **${score}**/100 | ${advice}`\n    }\n  },\n  {\n    tag: 'hr'\n  },\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `ğŸ’¡ **æ ¸å¿ƒç»“è®º**ï¼š\\n${summary}`\n    }\n  },\n  // æŠŠæŠ€æœ¯æŒ‡æ ‡ç®€åŒ–æ˜¾ç¤ºï¼Œé˜²æ­¢å¡ç‰‡å¤ªé•¿\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `ğŸ’° ç°ä»·: **${getVal('ç°ä»·', 'current_price', 0)}** | æ­¢æŸ: ${getVal('æ­¢æŸä»·', 'stop_loss', 0)} | ç›®æ ‡: ${getVal('ç›®æ ‡ä»·', 'take_profit', 0)}`\n    }\n  },\n  {\n    tag: 'action',\n    actions: [\n      {\n        tag: 'button',\n        text: { tag: 'plain_text', content: 'ğŸ“Š æŸ¥çœ‹å®Œæ•´æ•°æ®è¡¨' },\n        type: (color === 'green') ? 'primary' : 'default', // åªæœ‰ä¹°å…¥æ‰é«˜äº®æŒ‰é’®\n        url: 'https://xcnf59usubzt.feishu.cn/base/RVghbRvYgacqs3s82qkcl83bn7e?table=tblvrNDNrjAZwBZc'\n      }\n    ]\n  },\n  {\n    tag: 'note',\n    elements: [\n      {\n        tag: 'plain_text',\n        content: `V7.4 Linear | ${stockName}(${code})`\n      }\n    ]\n  }\n];\n\nreturn {\n  json: {\n    card_color: color,\n    card_content: cardContent,\n    header_title: `ğŸ“Š ${stockName} æ¯æ—¥åˆ†æ`\n  }\n};\n"
      },
      "id": "eb1b8f74-6119-4803-b22a-ee3693ff54b2",
      "name": "æ„å»ºé€šç”¨å¡ç‰‡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8600,
        1780
      ],
      "onError": "continueRegularOutput",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "message:send",
        "receive_id_type": "user_id",
        "receive_id": "bg99a8dc",
        "msg_type": "interactive",
        "content": "={{\nJSON.stringify({\n  \"config\": {\n    \"wide_screen_mode\": true\n  },\n  \"header\": {\n    \"template\": $json.card_color,\n    \"title\": {\n      \"content\": $json.header_title,\n      \"tag\": \"plain_text\"\n    }\n  },\n  \"elements\": $json.card_content\n})\n}}"
      },
      "id": "0cd09360-d311-4dab-b3d8-dc27055fc9a4",
      "name": "å‘é€é€šç”¨æ¶ˆæ¯",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        -8400,
        1780
      ],
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘_å·¥ä½œæ—¥18ç‚¹": {
      "main": [
        [
          {
            "node": "Global Context (API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global Context (API)": {
      "main": [
        [
          {
            "node": "è¯»å–è‚¡ç¥¨åˆ—è¡¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¯»å–è‚¡ç¥¨åˆ—è¡¨": {
      "main": [
        [
          {
            "node": "å¾ªç¯å¤„ç†æ¯åªè‚¡ç¥¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¾ªç¯å¤„ç†æ¯åªè‚¡ç¥¨": {
      "main": [
        [
          {
            "node": "Full Stack Analysis (API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Full Stack Analysis (API)": {
      "main": [
        [
          {
            "node": "Tavilyæ–°é—»æœç´¢",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tavilyæ–°é—»æœç´¢": {
      "main": [
        [
          {
            "node": "æ„å»ºAIæç¤ºè¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºAIæç¤ºè¯": {
      "main": [
        [
          {
            "node": "AIåˆ†æAgent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIåˆ†æAgent": {
      "main": [
        [
          {
            "node": "è§£æAIåˆ†æç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æAIåˆ†æç»“æœ": {
      "main": [
        [
          {
            "node": "å†™å…¥é£ä¹¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†™å…¥é£ä¹¦": {
      "main": [
        [
          {
            "node": "æ„å»ºé€šç”¨å¡ç‰‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºé€šç”¨å¡ç‰‡": {
      "main": [
        [
          {
            "node": "å‘é€é€šç”¨æ¶ˆæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€é€šç”¨æ¶ˆæ¯": {
      "main": [
        [
          {
            "node": "å¾ªç¯å¤„ç†æ¯åªè‚¡ç¥¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AIåˆ†æAgent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "instanceId": "2f742d99bafc29685192c328e0fdaa64b8db6ce3b25050806eb96df939878538"
  }
}